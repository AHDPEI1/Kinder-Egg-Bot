import random
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes

TOKEN = "YOUR_TELEGRAM_BOT_TOKEN_HERE"

# ‚Äî‚Äî‚Äî‚Äî‚Äî –°–ü–ò–°–û–ö –§–ò–ì–£–†–û–ö ‚Äî‚Äî‚Äî‚Äî‚Äî
FIGURES = [
    "–î–∞—Å—Ç–∏–Ω", "–î–∞—Å—Ç–∏–Ω –∏–∑ –∏–∑–Ω–∞–Ω–∫–∏",
    "–ú–∞–π–∫",
    "–£–∏–ª–ª", "–£–∏–ª–ª –∏–∑ –∏–∑–Ω–∞–Ω–∫–∏",
    "–õ—É–∫–∞—Å",
    "–ú–∞–∫—Å",
    "–û–¥–∏ –∏–∑ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏",
    "–û–¥–∏ –∏–∑ –∏–∑–Ω–∞–Ω–∫–∏",
    "–û–¥–∏ –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–º —Ö–∞–ª–∞—Ç–µ",
    "–î–µ–º–æ–≥—Ä–≥–æ–Ω –Ω–∞ –∫–∞—Ä–∞–Ω–¥–∞—à",
    "–î–µ–º–æ–≥–æ—Ä–≥–æ–Ω-–±—Ä–µ–ª–æ–∫", "–î–µ–º–æ–≥–æ—Ä–≥–æ–Ω-–±—Ä–µ–ª–æ–∫ –Ω–∞ —Å–∫—Ä–µ–ø–∫–µ",
    "–°—Ç–∏–≤", "–°—Ç–∏–≤ –∏–∑ –∏–∑–Ω–∞–Ω–∫–∏",
    "–í–µ–∫–Ω–∞",
    "–≠—Ä–∏–∫–∞",
    "–•–æ–ø–ø–µ—Ä", "–•–æ–ø–ø–µ—Ä –∏–∑ –∏–∑–Ω–∞–Ω–∫–∏",
    "–ù—ç–Ω—Å–∏",
    "–†–æ–±–∏–Ω –∏–∑ –∏–∑–Ω–∞–Ω–∫–∏",
    "–≠–¥–¥–∏ –∏–∑ –∏–∑–Ω–∞–Ω–∫–∏",
    "–ú–∞–∫—Å –∏–∑ –∏–∑–Ω–∞–Ω–∫–∏",
    "–°–≤—è–∑–∞–Ω–Ω—ã–µ –°—Ç–∏–≤ –∏ –†–æ–±–∏–Ω"
]

PROBABILITIES = None  # –≤—ã—á–∏—Å–ª–∏–º –ø–æ–∑–∂–µ

# ‚Äî‚Äî‚Äî‚Äî‚Äî START ‚Äî‚Äî‚Äî‚Äî‚Äî
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["eggs"] = list(range(1, 25))
    context.user_data["collection"] = []

    await update.message.reply_photo(
        photo="https://i.ibb.co/PmFQh0V/kinder-eggs-24.png",
        caption="–í—ã–±–µ—Ä–∏ —è–π—Ü–æ: –Ω–∞–ø–∏—à–∏ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 24."
    )

# ‚Äî‚Äî‚Äî‚Äî‚Äî –û–¢–ö–†–´–¢–ò–ï –Ø–ô–¶–ê ‚Äî‚Äî‚Äî‚Äî‚Äî
async def open_egg(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text

    if not text.isdigit():
        await update.message.reply_text("–í–≤–µ–¥–∏ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 24!")
        return

    egg = int(text)

    if egg not in context.user_data.get("eggs", []):
        await update.message.reply_text("–≠—Ç–æ —è–π—Ü–æ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ. –í—ã–±–µ—Ä–∏ –¥—Ä—É–≥–æ–µ!")
        return

    # –£–¥–∞–ª—è–µ–º —è–π—Ü–æ
    context.user_data["eggs"].remove(egg)

    # ‚Äî –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ ‚Äî
    global PROBABILITIES
    if PROBABILITIES is None:
        total = len(FIGURES)
        p_will = 0.005
        p_will_dark = 0.01
        remaining = total - 2
        p_other = (1 - p_will - p_will_dark) / remaining
        PROBABILITIES = []
        for f in FIGURES:
            if f == "–£–∏–ª–ª": PROBABILITIES.append(p_will)
            elif f == "–£–∏–ª–ª –∏–∑ –∏–∑–Ω–∞–Ω–∫–∏": PROBABILITIES.append(p_will_dark)
            else: PROBABILITIES.append(p_other)

    # ‚Äî –í—ã–ø–∞–≤—à–∞—è —Ñ–∏–≥—É—Ä–∫–∞ ‚Äî
    figure = random.choices(FIGURES, weights=PROBABILITIES, k=1)[0]

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é
    context.user_data["collection"].append(figure)

    await update.message.reply_text(f"ü•ö –¢—ã –æ—Ç–∫—Ä—ã–ª —è–π—Ü–æ ‚Ññ{egg}!")
    await update.message.reply_text(f"üéÅ –¢–µ–±–µ –≤—ã–ø–∞–ª–∞: *{figure}*!",
                                    parse_mode="Markdown")

    # ‚Äî –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é ‚Äî
    unique = {}
    for item in context.user_data["collection"]:
        unique[item] = unique.get(item, 0) + 1

    text = "\n".join([f"{name}: {count}" for name, count in unique.items()])
    await update.message.reply_text(f"üì¶ *–¢–≤–æ—è –∫–æ–ª–ª–µ–∫—Ü–∏—è:* \n{text}",
                                    parse_mode="Markdown")


async def main():
    app = ApplicationBuilder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, open_egg))
    await app.run_polling()


import asyncio
asyncio.run(main())
